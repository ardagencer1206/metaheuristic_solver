<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <title>ALNS + OSRM + Flask</title>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>#map{height:80vh}</style>
</head>
<body>
  <h3>Araç Başlangıçları (Depolar)</h3>
  <textarea id="depots" rows="3" cols="40">41.015,28.979
39.933,32.859</textarea>
  <h3>Uğraklar</h3>
  <textarea id="stops" rows="6" cols="40">40.195,29.060
38.423,27.142
36.897,30.713</textarea><br>
  <button onclick="solve()">Çöz</button>
  <div id="map"></div>

<script>
const map = L.map('map').setView([39,35],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let layers=[];

function parseLines(id){
  return document.getElementById(id)
    .value.split('\n')
    .map(s=>s.trim())
    .filter(Boolean)
    .map(s=>s.split(',').map(x=>Number(x.trim())));
}

async function solve(){
  // temizle
  layers.forEach(l=>map.removeLayer(l)); layers=[];

  const depots = parseLines("depots");
  const stops  = parseLines("stops");

  try {
    const res = await fetch("/alns/solve", {   // <— DÜZELTME
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ depots, stops })
    });
    if(!res.ok){
      const t = await res.text();
      alert("Sunucu hatası: " + res.status + " " + t);
      return;
    }
    const data = await res.json();
    if(!data.trips || data.trips.length===0){
      alert("Rota bulunamadı veya boş sonuç.");
      return;
    }
    data.trips.forEach((t,i)=>{
      const geo = t.trip.trips[0].geometry;
      const line = L.geoJSON(geo,{color:['#e74c3c','#0d6efd','#2ecc71','#9b59b6','#ff9f43'][i%5], weight:5, opacity:0.9}).addTo(map);
      layers.push(line);
      if(i===0) map.fitBounds(line.getBounds(),{padding:[20,20]});
    });
  } catch(err){
    console.error(err);
    alert("İstek/JS hatası: " + err.message);
  }
}
</script>

</body>
</html>
