<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <title>ALNS + OSRM Çoklu Araç</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial}
    header, .panel{padding:12px 16px}
    .grid{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    textarea,input,button,select{padding:8px;border:1px solid #ccc;border-radius:8px}
    button{background:#0d6efd;color:#fff;border:0;cursor:pointer}
    #map{height:65vh;margin:12px 16px;border-radius:10px}
    .legend{display:flex;flex-wrap:wrap;gap:8px;padding:0 16px 12px 16px}
    .tag{display:inline-flex;align-items:center;gap:6px;background:#f2f2f2;border-radius:999px;padding:2px 10px}
    .dot{width:10px;height:10px;border-radius:50%}
    @media(max-width:900px){.grid{grid-template-columns:1fr} #map{height:60vh}}
  </style>
</head>
<body>
  <header><b>Çoklu Araç Rota Planlama</b> — ALNS Python, görselleştirme Leaflet</header>

  <div class="panel grid">
    <div>
      <label><b>Depolar (araç başlangıçları)</b> — her satıra <i>enlem, boylam</i></label><br>
      <textarea id="depots" rows="5">41.015,28.979
39.933,32.859
38.423,27.142</textarea>
    </div>
    <div>
      <label><b>Uğraklar</b> — her satıra <i>enlem, boylam</i></label><br>
      <textarea id="stops" rows="5">40.195,29.060
37.066,37.383
36.897,30.713
41.657,26.563
40.155,26.414
37.875,32.493
40.983,37.876
39.750,39.500
38.731,35.479
36.812,34.642</textarea>
    </div>
  </div>

  <div class="panel" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <label for="method"><b>Çözüm Metodu:</b></label>
    <select id="method">
      <option value="alns" selected>ALNS</option>
      <option value="greedy">Greedy</option>
    </select>
    <button id="btnSolve">Çöz</button>
    <button id="btnClear" style="background:#6c757d">Temizle</button>
    <span id="status" style="margin-left:8px;color:#444">Hazır.</span>
  </div>

  <div class="legend" id="legend"></div>
  <div id="map"></div>

<script>
const map = L.map('map').setView([39,35],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'© OpenStreetMap'}).addTo(map);

let layers=[]; let markers=[];
function clearMap(){
  layers.forEach(l=>map.removeLayer(l)); layers=[];
  markers.forEach(m=>map.removeLayer(m)); markers=[];
  document.getElementById('legend').innerHTML='';
}
function parseLines(id){
  return document.getElementById(id).value
    .split('\n').map(s=>s.trim()).filter(Boolean)
    .map(s=>{
      const p=s.split(',').map(x=>Number(x.trim()));
      if(p.length!==2 || !isFinite(p[0]) || !isFinite(p[1])) throw new Error('Format: "enlem, boylam"');
      return [p[0], p[1]];
    });
}
const palette=['#e74c3c','#0d6efd','#2ecc71','#9b59b6','#ff9f43','#1abc9c','#8e44ad','#34495e','#d35400','#27ae60'];
function numIcon(n, colorHex){
  return L.divIcon({
    className:'num-ico',
    html:`<div style="width:28px;height:28px;border-radius:50%;background:${colorHex};color:#fff;display:flex;align-items:center;justify-content:center;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,.35)">${n}</div>`,
    iconSize:[28,28], iconAnchor:[14,28], popupAnchor:[0,-24]
  });
}
const truckIcon = L.icon({
  iconUrl: 'https://cdn-icons-png.flaticon.com/512/743/743007.png',
  iconSize: [32,32],
  iconAnchor: [16,32],
  popupAnchor: [0,-28]
});
function fmtMin(s){return `${Math.round(s/60)} dk`;}
function fmtKm(m){return (m/1000).toFixed(1)+' km';}

// Animasyonlu rota çizimi
function animateRoute(coords, color, onFinish){
  let i = 0;
  const polyline = L.polyline([], {color: color, weight:5, opacity:.9}).addTo(map);
  layers.push(polyline);

  function step(){
    if(i < coords.length){
      polyline.addLatLng([coords[i][1], coords[i][0]]);
      i++;
      setTimeout(step, 5); // daha hızlı animasyon
    }else if(onFinish){
      onFinish();
    }
  }
  step();
}

async function solve(){
  const status = document.getElementById('status');
  status.textContent='Hesaplanıyor...'; 
  document.getElementById('btnSolve').disabled=true;

  clearMap();
  let depots, stops;
  try{
    depots = parseLines('depots');
    stops  = parseLines('stops');
  }catch(e){
    status.textContent='Hata: ' + e.message;
    document.getElementById('btnSolve').disabled=false;
    return;
  }
  try{
    const method = document.getElementById("method").value;
    const res = await fetch("/alns/solve", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({depots, stops, method})
    });
    if(!res.ok){ const t=await res.text(); throw new Error(res.status+' '+t); }
    const data = await res.json();
    if(!data.trips || data.trips.length===0){ status.textContent='Rota yok.'; return; }

    const legend = document.getElementById('legend');
    let bounds=null, totalDur=0, totalDist=0;

    function drawTrip(idx){
      if(idx >= data.trips.length){
        status.textContent = `Araç: ${data.trips.length} • Toplam süre: ${fmtMin(totalDur)} • Toplam mesafe: ${fmtKm(totalDist)}`;
        return;
      }
      const t = data.trips[idx];
      const col = palette[idx % palette.length];
      const trip = t.trip.trips[0];
      totalDur += trip.duration; totalDist += trip.distance;

      // animasyonlu rota çizimi
      const coords = trip.geometry.coordinates;
      animateRoute(coords, col, ()=>drawTrip(idx+1));

      // markerlar
      const ordered = t.trip.waypoints
        .slice()
        .sort((a,b)=>a.waypoint_index - b.waypoint_index)
        .map(w=>({lat:w.location[1], lon:w.location[0]}));

      ordered.forEach((p, k)=>{
        if(k===0){
          const mk = L.marker([p.lat, p.lon], {icon: truckIcon}).addTo(map).bindPopup(`Araç ${idx+1} Başlangıç`);
          markers.push(mk);
        }else{
          const mk = L.marker([p.lat, p.lon], {icon: numIcon(k+1, col)}).addTo(map).bindPopup(`Araç ${idx+1} Uğrak #${k}`);
          markers.push(mk);
        }
      });

      // legend
      const tag = document.createElement('div');
      tag.className='tag';
      tag.innerHTML = `<span class="dot" style="background:${col}"></span> Araç ${idx+1}: ${fmtMin(trip.duration)}, ${fmtKm(trip.distance)}`;
      legend.appendChild(tag);

      bounds = bounds ? bounds.extend(L.latLngBounds(ordered.map(p=>[p.lat,p.lon]))) : L.latLngBounds(ordered.map(p=>[p.lat,p.lon]));
      if(bounds) map.fitBounds(bounds, {padding:[20,20]});
    }

    drawTrip(0); // ilk aracı çiz
  }catch(err){
    console.error(err);
    status.textContent='Hata: '+err.message;
  }finally{
    document.getElementById('btnSolve').disabled=false;
  }
}

document.getElementById('btnSolve').onclick=solve;
document.getElementById('btnClear').onclick=()=>{ clearMap(); document.getElementById('status').textContent='Temizlendi.'; };
</script>
</body>
</html>
